
Процедура КнопкаВыполнитьНажатие(Кнопка)
	// Вставить содержимое обработчика.
	// 
	ПрочитатьФайлВерсий();
	История.Сортировать("НомерВерсии");
	Для каждого ЭлеменСтроки Из История Цикл
		
		//1. Сохраним конфигурацию. 
		//
		ОбработкаПрерыванияПользователя();
		
		Если ПоследняяВерсияХранилища>0 Тогда
				
			Если ПоследняяВерсияХранилища <> ЭлеменСтроки.НомерВерсии Тогда
				Продолжить;
			КонецЕсли;
		КонецЕсли;
		
		Если НомерВерсии > 0 И НомерВерсии > ЭлеменСтроки.НомерВерсии Тогда
			Продолжить;
		КонецЕсли;
		
		Параметры = Новый Структура;
		Параметры.Вставить("ПутьКБазе", ПутьКБазе);
		Параметры.Вставить("ПутьКХранилищу", ПутьКХранилищу);
		Параметры.Вставить("ПользовательХранилща", ПользовательХранилща);
		Параметры.Вставить("ПарольХранилища", ПарольХранилища);
		Параметры.Вставить("ПутьКДанным", ПутьКДанным);
		Параметры.Вставить("Пользователь", Пользователь);
		Параметры.Вставить("Пароль", Пароль);
		Параметры.Вставить("ПоследняяВерсияХранилища", ЭлеменСтроки.НомерВерсии);
		
		Параметры.Вставить("Автор",ЭлеменСтроки.Автор);
		Параметры.Вставить("Версия", ЭлеменСтроки.НомерВерсии);
		Параметры.Вставить("Комментарий",""+ЭлеменСтроки.Комментарий);
		Параметры.Вставить("Тэг", ЭлеменСтроки.Тэг);
		Параметры.Вставить("КаталогСтруктуры", ПутьКGit);
		
		Автор = ЭлеменСтроки.Автор;
		Версия = ЭлеменСтроки.НомерВерсии;
		Комментарий = ЭлеменСтроки.Комментарий;
	
		
		Если СохранитьКонфигурацию(Параметры) Тогда
			Возврат;
		КонецЕсли;
		
		Если СоздатьПустуюБазу(Параметры) Тогда
			Возврат;
		КонецЕсли;
		
		Если ВыгрузитьМодули(Параметры) Тогда
			Возврат;
		КонецЕсли;
		
		СкопироватьСтруктуруИСделатьCommit(Параметры);
		
		ЭлементОбъект = Конфигурация.ПолучитьОбъект();
		ЗаполнитьЗначенияСвойств(ЭлементОбъект, Параметры);
		ЭлементОбъект.Записать();
		
	КонецЦикла;
КонецПроцедуры

Процедура КонфигурацияПриИзменении(Элемент)
	
	ПутьКХранилищу       = Конфигурация.ПутьКХранилищу;
	ПользовательХранилща = Конфигурация.ПользовательХранилща;
	ПарольХранилища      = Конфигурация.ПарольХранилища;
	//ПутьКДанным          = Конфигурация.ПутьКДанным;
	Пользователь         = Конфигурация.Пользователь;
	Пароль               = Конфигурация.Пароль;
	//ПутьКБазе			 = СтрЗаменить(Конфигурация.ПутьКБазе, "File=";
	
КонецПроцедуры

Процедура ОбработкаОповещения(Событие, Параметр, Источник) Экспорт
	
	Если Событие = "ЗакрытьФорму" И ЗначениеЗаполнено(Параметр) И Параметр = "v83unpack" Тогда
		ЭтаФорма.Закрыть();
	КонецЕсли;
	
КонецПроцедуры



Процедура ПриОткрытии()
	
	Если ЗначениеЗаполнено(ПараметрЗапуска) Тогда
		ПодключитьОбработчикОповещения("ОбработкаОповещения");
		ЭтотОбъект.ОбарботатьПараметрыЗапуска();
	КонецЕсли;
	
	ПутьКБазе = ВосстановитьЗначение("ПутьКБазе");
	ПутьКХранилищу = ВосстановитьЗначение("ПутьКХранилищу");
	ПользовательХранилща = ВосстановитьЗначение("ПользовательХранилща");
	ПарольХранилища = ВосстановитьЗначение("ПарольХранилища");
	ПутьКДанным = ВосстановитьЗначение("ПутьКДанным");
	Пользователь = ВосстановитьЗначение("Пользователь");
	Пароль = ВосстановитьЗначение("Пароль");
	ПоследняяВерсияХранилища = ВосстановитьЗначение("ПоследняяВерсияХранилища");
	ИмяФайлаВыгрузкиКонфигурации = ВосстановитьЗначение("ИмяФайлаВыгрузкиКонфигурации");
	КаталогВыгрузки = ВосстановитьЗначение("КаталогВыгрузки");
	ИмяКаталогаБазы = ВосстановитьЗначение("ИмяКаталогаБазы");
	КаталогСтруктуры = ВосстановитьЗначение("КаталогСтруктуры");
	ПутьКФайлуВерсий = ВосстановитьЗначение("ПутьКФайлуВерсий");

КонецПроцедуры


Процедура ОсновныеДействияФормыКнопкаСохранитьКонфигурацию(Кнопка)
	
	Параметры = Новый Структура;
	Параметры.Вставить("ПутьКБазе", ПутьКБазе);
	Параметры.Вставить("ПутьКХранилищу", ПутьКХранилищу);
	Параметры.Вставить("ПользовательХранилща", ПользовательХранилща);
	Параметры.Вставить("ПарольХранилища", ПарольХранилища);
	Параметры.Вставить("ПутьКДанным", ПутьКДанным);
	Параметры.Вставить("Пользователь", Пользователь);
	Параметры.Вставить("Пароль", Пароль);
	Параметры.Вставить("ПоследняяВерсияХранилища", ПоследняяВерсияХранилища);
	Параметры.Вставить("ИмяФайлаВыгрузкиКонфигурации", ИмяФайлаВыгрузкиКонфигурации);
	Параметры.Вставить("КаталогВыгрузки", КаталогВыгрузки);
	Параметры.Вставить("ИмяКаталогаБазы", ИмяКаталогаБазы);
	//Параметры.Вставить("Автор",ЭлеменСтроки.Автор);
	//Параметры.Вставить("Комментарий","ver:"+Строка(ЭлеменСтроки.НомерВерсии)+" "+ЭлеменСтроки.Комментарий);
	//Параметры.Вставить("Тэг", ЭлеменСтроки.Тэг);
	Параметры.Вставить("КаталогСтруктуры", ПутьКGit);
	
	Если СохранитьКонфигурацию(Параметры) Тогда
		Возврат;
	КонецЕсли;
		
КонецПроцедуры


Процедура ОсновныеДействияФормыДействиеСоздатьПустуюБазу(Кнопка)
	
	Параметры = Новый Структура;
	Параметры.Вставить("ПутьКБазе", ПутьКБазе);
	Параметры.Вставить("ПутьКХранилищу", ПутьКХранилищу);
	Параметры.Вставить("ПользовательХранилща", ПользовательХранилща);
	Параметры.Вставить("ПарольХранилища", ПарольХранилища);
	Параметры.Вставить("ПутьКДанным", ПутьКДанным);
	Параметры.Вставить("Пользователь", Пользователь);
	Параметры.Вставить("Пароль", Пароль);
	Параметры.Вставить("ПоследняяВерсияХранилища", ПоследняяВерсияХранилища);
	
	Параметры.Вставить("ИмяФайлаВыгрузкиКонфигурации", ИмяФайлаВыгрузкиКонфигурации);
	Параметры.Вставить("КаталогВыгрузки", КаталогВыгрузки);
	Параметры.Вставить("ИмяКаталогаБазы", ИмяКаталогаБазы);
	
	//Параметры.Вставить("Автор",ЭлеменСтроки.Автор);
	//Параметры.Вставить("Комментарий","ver:"+Строка(ЭлеменСтроки.НомерВерсии)+" "+ЭлеменСтроки.Комментарий);
	//Параметры.Вставить("Тэг", ЭлеменСтроки.Тэг);
	Параметры.Вставить("КаталогСтруктуры", ПутьКGit);
	
	Если СоздатьПустуюБазу(Параметры) Тогда
		Возврат;
	КонецЕсли;
	
КонецПроцедуры


Процедура ОсновныеДействияФормыДействиеВыгрузитьМодули(Кнопка)
	
	Параметры = Новый Структура;
	Параметры.Вставить("ПутьКБазе", ПутьКБазе);
	Параметры.Вставить("ПутьКХранилищу", ПутьКХранилищу);
	Параметры.Вставить("ПользовательХранилща", ПользовательХранилща);
	Параметры.Вставить("ПарольХранилища", ПарольХранилища);
	Параметры.Вставить("ПутьКДанным", ПутьКДанным);
	Параметры.Вставить("Пользователь", Пользователь);
	Параметры.Вставить("Пароль", Пароль);
	Параметры.Вставить("ПоследняяВерсияХранилища", ПоследняяВерсияХранилища);
	
	Параметры.Вставить("ИмяФайлаВыгрузкиКонфигурации", ИмяФайлаВыгрузкиКонфигурации);
	Параметры.Вставить("КаталогВыгрузки", КаталогВыгрузки);
	Параметры.Вставить("ИмяКаталогаБазы", ИмяКаталогаБазы);
	
	//Параметры.Вставить("Автор",ЭлеменСтроки.Автор);
	//Параметры.Вставить("Комментарий","ver:"+Строка(ЭлеменСтроки.НомерВерсии)+" "+ЭлеменСтроки.Комментарий);
	//Параметры.Вставить("Тэг", ЭлеменСтроки.Тэг);
	Параметры.Вставить("КаталогСтруктуры", ПутьКGit);
	
	Если ВыгрузитьМодули(Параметры) Тогда
		Возврат;
	КонецЕсли;
	
КонецПроцедуры


Процедура ОсновныеДействияФормыДействиеКоммит(Кнопка)
	
	Параметры = Новый Структура;
	Параметры.Вставить("ПутьКБазе", ПутьКБазе);
	Параметры.Вставить("ПутьКХранилищу", ПутьКХранилищу);
	Параметры.Вставить("ПользовательХранилща", ПользовательХранилща);
	Параметры.Вставить("ПарольХранилища", ПарольХранилища);
	Параметры.Вставить("ПутьКДанным", ПутьКДанным);
	Параметры.Вставить("Пользователь", Пользователь);
	Параметры.Вставить("Пароль", Пароль);
	Параметры.Вставить("ПоследняяВерсияХранилища", ПоследняяВерсияХранилища);
	
	Параметры.Вставить("ИмяФайлаВыгрузкиКонфигурации", ИмяФайлаВыгрузкиКонфигурации);
	Параметры.Вставить("КаталогВыгрузки", КаталогВыгрузки);
	Параметры.Вставить("ИмяКаталогаБазы", ИмяКаталогаБазы);
	
	Параметры.Вставить("Автор", Автор);
	Параметры.Вставить("Версия", НомерВерсии);
	Параметры.Вставить("Комментарий", Комментарий);
	//Параметры.Вставить("Комментарий","ver:"+Строка(ЭлеменСтроки.НомерВерсии)+" "+ЭлеменСтроки.Комментарий);
	//Параметры.Вставить("Тэг", ЭлеменСтроки.Тэг);
	Параметры.Вставить("КаталогСтруктуры", ПутьКGit);
	
	СкопироватьСтруктуруИСделатьCommit(Параметры);
	
КонецПроцедуры


Процедура ПередЗакрытием(Отказ, СтандартнаяОбработка)
	// Вставить содержимое обработчика.
КонецПроцедуры


Процедура ПриЗакрытии()
	
	СохранитьЗначение("ПутьКБазе", ПутьКБазе);
	СохранитьЗначение("ПутьКХранилищу", ПутьКХранилищу);
	СохранитьЗначение("ПользовательХранилща", ПользовательХранилща);
	СохранитьЗначение("ПарольХранилища", ПарольХранилища);
	СохранитьЗначение("ПутьКДанным", ПутьКДанным);
	СохранитьЗначение("Пользователь", Пользователь);
	СохранитьЗначение("Пароль", Пароль);
	СохранитьЗначение("ПоследняяВерсияХранилища", ПоследняяВерсияХранилища);
	
	СохранитьЗначение("ИмяФайлаВыгрузкиКонфигурации", ИмяФайлаВыгрузкиКонфигурации);
	СохранитьЗначение("КаталогВыгрузки", КаталогВыгрузки);
	СохранитьЗначение("ИмяКаталогаБазы", ИмяКаталогаБазы);
	
	СохранитьЗначение("Автор", Автор);
	СохранитьЗначение("Версия", НомерВерсии);
	СохранитьЗначение("Комментарий", Комментарий);
	//СохранитьЗначение("Комментарий","ver:"+Строка(ЭлеменСтроки.НомерВерсии)+" "+ЭлеменСтроки.Комментарий);
	//СохранитьЗначение("Тэг", ЭлеменСтроки.Тэг);
	СохранитьЗначение("КаталогСтруктуры", ПутьКGit);
	СохранитьЗначение("ПутьКФайлуВерсий", ПутьКФайлуВерсий);
	
КонецПроцедуры


Процедура ДействияФормыДействиеЗагрузитьВерсии(Кнопка)
	ПрочитатьФайлВерсий();
	История.Сортировать("НомерВерсии");
	
КонецПроцедуры

Процедура ОсновныеДействияФормыСохранитьКонфигурацииПакетно(Кнопка)
	
	ПрочитатьФайлВерсий();
	История.Сортировать("НомерВерсии");
	Для каждого ЭлеменСтроки Из История Цикл
		
		//1. Сохраним конфигурацию. 
		//
		
		Если ПоследняяВерсияХранилища>0 Тогда
				
			Если ПоследняяВерсияХранилища <> ЭлеменСтроки.НомерВерсии Тогда
				Продолжить;
			КонецЕсли;
		КонецЕсли;
		
		Если НомерВерсии > 0 И НомерВерсии > ЭлеменСтроки.НомерВерсии Тогда
			Продолжить;
		КонецЕсли;
		
		Параметры = Новый Структура;
		Параметры.Вставить("ПутьКБазе", ПутьКБазе);
		Параметры.Вставить("ПутьКХранилищу", ПутьКХранилищу);
		Параметры.Вставить("ПользовательХранилща", ПользовательХранилща);
		Параметры.Вставить("ПарольХранилища", ПарольХранилища);
		Параметры.Вставить("ПутьКДанным", ПутьКДанным);
		Параметры.Вставить("Пользователь", Пользователь);
		Параметры.Вставить("Пароль", Пароль);
		Параметры.Вставить("ПоследняяВерсияХранилища", ЭлеменСтроки.НомерВерсии);
		
		Параметры.Вставить("Автор",ЭлеменСтроки.Автор);
		Параметры.Вставить("Версия", ЭлеменСтроки.НомерВерсии);
		Параметры.Вставить("Комментарий",""+ЭлеменСтроки.Комментарий);
		Параметры.Вставить("Тэг", ЭлеменСтроки.Тэг);
		Параметры.Вставить("КаталогСтруктуры", ПутьКGit);
		
		Автор = ЭлеменСтроки.Автор;
		Версия = ЭлеменСтроки.НомерВерсии;
		Комментарий = ЭлеменСтроки.Комментарий;
	
		
		Если СохранитьКонфигурацию(Параметры) Тогда
			Возврат;
		КонецЕсли;
		
	КонецЦикла;
КонецПроцедуры



